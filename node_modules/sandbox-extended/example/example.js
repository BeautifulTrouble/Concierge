var Sandbox = require("sandbox-extended");

var s = new Sandbox();

var output = [];

var index = 0;

var createHandlers = function () {
    index++;
    var example = 'Example ' + (index < 10 ? '0' : '') + index + ': ';
    return {
        'console.log': function (msg) {
            console.log(example + 'console.log -> ' + JSON.stringify(msg));
            process.stdout.write('\n--------------------------\n');
        },
        'print': function (msg) {
            console.log(example + 'console.log -> ' + JSON.stringify(msg));
            process.stdout.write('\n--------------------------\n');
        },
        'timeout': function (msg) {
            console.log(example + 'timeout -> ' + JSON.stringify(msg));
            process.stdout.write('\n--------------------------\n');
        },
        'exception': function (msg) {
            console.log(example + 'exception -> ' + msg.name + ':' + msg.message);
            process.stdout.write(msg.stack)
            process.stdout.write('\n--------------------------\n');
        },
        'result': function (msg) {
            console.log(example + 'result -> ' + JSON.stringify(msg));
            process.stdout.write('\n--------------------------\n');
        }
    }
};


// Example 1 - Standard JS
s.run("1 + 1", createHandlers());

// Example 2 - Something slightly more complex
s.run("(function(name) { return 'Hi there, ' + name + '!'; })('Fabio')", createHandlers())

// Example 3 - Syntax error
s.run("lol)hai", createHandlers());

// Example 4 - Restricted code
s.run("process.platform", createHandlers())

// Example 5 - Infinite loop
s.run("while (true) {}", createHandlers())

// Example 6 - Caller Attack Failure
s.run("(function foo() {return foo.caller.caller;})()", createHandlers())

// Example 7 - Argument Attack Failure
s.run("(function foo() {return [].slice.call(foo.caller.arguments);})()", createHandlers())

// Example 8 - Type Coersion Attack Failure
s.run("(function foo() {return {toJSON:function x(){return x.caller.caller.name}}})()", createHandlers())

// Example 9 - Global Attack Failure
var example09 =
'this.x=1;                                                                                                              ' +
'var v = (function() {return this})().console.log.constructor("return this")();                                         ' +
    'console.log("a");                                                                                                  ' +
    'console.log("b");                                                                                                  ' +
    'console.log("c");                                                                                                  ' +
'JSON.stringify(v)                                                                                                      ' +
'                                                                                                                       '
;

s.run(example09, createHandlers())
s.run("var x = 5; console.log(x * x); x", createHandlers())
